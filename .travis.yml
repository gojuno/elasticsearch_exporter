language: go

go:
  - 1.10.x
  - 1.11.x
  - tip

before_install:
  # gox simplifies building for multiple architectures
  - go get github.com/mitchellh/gox

script:
  - make style
  - make vet
  - make gometalinter
  - make build
  - make test
  - export VERSION=$(git describe --tags)
  - gox -os="linux darwin" -arch="amd64" -output="elasticsearch_exporter_multicluster_${VERSION}_{{.OS}}_{{.Arch}}" -verbose ./...

deploy:

  provider: releases
  skip_cleanup: true
  api_key:
    secure: KHU1pTMWYo4AIvPwUNxpn5/Wn3krFbV2mb8lScPFqaw9JsIOluS7mvelGcjvhBU6+z7nZBjCXKoGFC0Y1v0F/JRNbrOSfp+HZPNLaWvdL8bxqVo0qQyZYRDKZALaB8370cgp+JglJhpmSpX1NhrZ9XFs2Tm6nw99UcutHXPbNHeIaQlpSr7ZPTRnVbiqTlf8e4AARz0wz0uj0s97ARCxl3J73lrnPY2VWoXBQ+xYeydnuzeR7hT6cispWLRALZbpTHVvrxS6p0Vbfu0Ef9JPh3/rNPinhmxwaDK18CkfzM0zDDGK0O1+OYhf+z1OyXRf6XSvMuEK8FmyAoXNrurucEm553yK4oTJFcE3OCOoYGvUKCsUjELeTBsXnd5Q6Xsgzwz8gN7q+OFNTzmM2izvmcEqDW2qE4Rg55dMB5oof0U0GjgU5254zBSA/jQ5nV6AFx9gp4zvJnCLsgTQvWgofEo2AgfcvJi5MOuUbg1fzL4jIxkQG59z4dzEytxDJOQPmtZKzK0vLyJ+xVWpWvWXV3k/Y7zX7UN3/yghJTYc5dTJBqeZIXK0v7BAVvkFO+xXWPEFPYogRiNH5x/8QVRvyE+ZDTn/hsSJkRWu3n8DJ6aPJXU5G9MDloQ2MdyoNdLuiNCUd3FEr74sbpUe4NeCIvmGo7oTEbpDTd+ZXHNBWoU=
  file_glob: true
  file:
    # The names of the binaries to output, based on the -output template passed to gox.
    - "elasticsearch_exporter_multicluster_${VERSION}_darwin_amd64"
    - "elasticsearch_exporter_multicluster_${VERSION}_linux_amd64"
  on:
    # What to repository to build
    repo: gojuno/elasticsearch_exporter
    # Only build binaries for tagged commits
    tags: true

matrix:
  allow_failures:
    - go: tip
